name: Tests
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Install JFlex
        run: |
          sudo apt-get update
          sudo apt-get install -y jflex

      - name: Build Project
        run: |
          cd ex3
          # Generate Lexer.java
          jflex -q -d src jflex/LEX_FILE.lex
          # Generate Parser.java and TokenNames.java
          java -jar external_jars/java-cup-11b.jar -nowarn -parser Parser -symbols TokenNames -destdir src cup/CUP_FILE.cup
          # Compile
          mkdir -p bin
          javac -cp external_jars/java-cup-11b-runtime.jar -d bin src/*.java src/*/*.java
          # Create JAR
          jar cfm SEMANT manifest/MANIFEST.MF -C bin .

      - name: Run Tests
        run: |
          cd ex3
          passed=0
          failed=0
          for i in 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20; do
            input_file=$(ls input/TEST_${i}_*.txt 2>/dev/null)
            expected_file=$(ls expected_output/TEST_${i}_*_Expected_Output.txt 2>/dev/null)
            if [ -z "$input_file" ] || [ -z "$expected_file" ]; then
              echo "TEST_${i}: SKIPPED (files not found)"
              continue
            fi
            java -jar SEMANT "$input_file" output/test_output.txt 2>/dev/null
            result=$(cat output/test_output.txt)
            expected=$(cat "$expected_file")
            if [ "$result" = "$expected" ]; then
              echo "TEST_${i}: PASS"
              ((passed++))
            else
              echo "TEST_${i}: FAIL (got '$result', expected '$expected')"
              ((failed++))
            fi
          done
          echo ""
          echo "Results: $passed passed, $failed failed"
          if [ $failed -gt 0 ]; then
            exit 1
          fi

